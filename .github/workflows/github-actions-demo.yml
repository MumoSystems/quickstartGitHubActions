name: Marketing GitHub Actions Demo
run-name: ${{ github.actor }} is demonstrating GitHub Actions 🚀
on:
  push:
  pull_request:
    types: closed
jobs:
  push_job:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Push event step
        run: echo "🚀 This job runs only on push events!"

  deploy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Wait for merge if not merged
        id: wait_for_merge
        run: |
          if [[ "${{ github.event.pull_request.merged }}" != "true" ]]; then
            echo "Pull request not merged. Waiting 5 minutes before checking again..."
            sleep 300
            # Fetch PR status again using GitHub API
            pr_number=${{ github.event.pull_request.number }}
            repo=${{ github.repository }}
            merged=$(gh pr view $pr_number --repo $repo --json merged --jq .merged)
            if [[ "$merged" != "true" ]]; then
              echo "Pull request still not merged after waiting. Exiting."
              exit 1
            fi
          fi
      - name: Simulate deploy to production
        if: success()
        run: echo "🚀 Simulating deployment to the production environment..."
      - run: echo "🍏 This job's status is ${{ job.status }}."